From 90d286c1e2261bddabdb84ea1e9a217516c4e44c Mon Sep 17 00:00:00 2001
From: Jose Quaresma <quaresma.jose@gmail.com>
Date: Sun, 8 Nov 2020 12:49:03 +0000
Subject: [PATCH 2/2] gstv4l2videodec: check if we have a pool before the
 locking in video decoder set format

There's a dead lock on nvv4l2decoder.
The dead lock is because the gstv4l2bufferpool only set capture_plane_stopped if the object
that use the poll are V4L2_TYPE_IS_OUTPUT and in this pipeline we have an encoder and h264parse
in front of the decoder.
This disable the pool on the nvv4l2decoder and because of this the gstv4l2bufferpool don't
set the capture_plane_stopped and nvv4l2decoder will waiting forever for this.

This only happens because the h264parse change the caps when the pipeline goes to running
that will trigger a restart of the nvv4l2decoder in the gst_v4l2_video_dec_set_format.

So disable the the check for capture_plane_stopped on nvv4l2decoder if we don't have a pool
otherwise nvv4l2decoder will hang forever waiting for capture_plane_stopped.

Signed-off-by: Jose Quaresma <quaresma.jose@gmail.com>
---
 gstv4l2videodec.c | 16 +++++++++-------
 1 file changed, 9 insertions(+), 7 deletions(-)

diff --git a/gstv4l2videodec.c b/gstv4l2videodec.c
index 6daf863..76a8f99 100644
--- a/gstv4l2videodec.c
+++ b/gstv4l2videodec.c
@@ -684,14 +684,16 @@ gst_v4l2_video_dec_set_format (GstVideoDecoder * decoder,
     self->output_flow = GST_FLOW_OK;
 
 #ifdef USE_V4L2_TARGET_NV
-    g_mutex_lock (&self->v4l2capture->cplane_stopped_lock);
-    while (self->v4l2capture->capture_plane_stopped != TRUE)
-    {
-        g_cond_wait (&self->v4l2capture->cplane_stopped_cond,
-                &self->v4l2capture->cplane_stopped_lock);
+    if (self->v4l2capture->pool ) {
+        g_mutex_lock (&self->v4l2capture->cplane_stopped_lock);
+        while (self->v4l2capture->capture_plane_stopped != TRUE)
+        {
+            g_cond_wait (&self->v4l2capture->cplane_stopped_cond,
+                    &self->v4l2capture->cplane_stopped_lock);
+        }
+        self->v4l2capture->capture_plane_stopped = FALSE;
+        g_mutex_unlock (&self->v4l2capture->cplane_stopped_lock);
     }
-    self->v4l2capture->capture_plane_stopped = FALSE;
-    g_mutex_unlock (&self->v4l2capture->cplane_stopped_lock);
     gst_v4l2_object_close (self->v4l2output);
     gst_v4l2_object_close (self->v4l2capture);
     gst_v4l2_object_open (self->v4l2output);
-- 
2.29.2

