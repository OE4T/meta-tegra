From b0ca9a7daabcebe89aa4048c45fd5cf85399bfba Mon Sep 17 00:00:00 2001
From: Ilies CHERGUI <ichergui@nvidia.com>
Date: Tue, 8 Jul 2025 19:02:29 +0100
Subject: [PATCH 1/7] v4l2videoenc: Fix negotiation caps leak

Part-of: <https://gitlab.freedesktop.org/gstreamer/gst-plugins-good/-/merge_requests/649>

Upstream-Status: Backport [https://gitlab.freedesktop.org/gstreamer/gst-plugins-good/-/merge_requests/649]
Signed-off-by: Jose Quaresma <quaresma.jose@gmail.com>
Signed-off-by: Ilies CHERGUI <ichergui@nvidia.com>
---
 gstv4l2videoenc.c | 3 +++
 1 file changed, 3 insertions(+)

diff --git a/gstv4l2videoenc.c b/gstv4l2videoenc.c
index 9cf065a..d7befc7 100644
--- a/gstv4l2videoenc.c
+++ b/gstv4l2videoenc.c
@@ -1413,6 +1413,9 @@ gst_v4l2_video_enc_negotiate (GstVideoEncoder * encoder)
     if (gst_caps_foreach (allowed_caps, negotiate_profile_and_level, &ctx)) {
       goto no_profile_level;
     }
+
+    gst_caps_unref (allowed_caps);
+    allowed_caps = NULL;
   }
 
   /* Set CUDA ENC GPU ID. This should be set before calling S_FMT on the capture plane*/
-- 
2.34.1

