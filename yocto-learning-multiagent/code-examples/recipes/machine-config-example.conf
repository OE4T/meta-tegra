# Machine Configuration Example for Custom Jetson Board
# This file demonstrates machine configuration for a custom Jetson-based board
#
# Location: meta-yourlayer/conf/machine/custom-jetson.conf
#
# Key concepts:
# - Machine architecture and tuning
# - Bootloader and kernel configuration
# - Hardware features and capabilities
# - Package architecture and feed configuration

#@TYPE: Machine
#@NAME: Custom Jetson Board
#@DESCRIPTION: Custom board based on NVIDIA Jetson TX2/Xavier/Orin

# Include common Tegra configuration
# This pulls in base configuration for Tegra platforms
require conf/machine/include/tegra-common.inc

# Machine name - must match filename
MACHINE = "custom-jetson"

# SOC family - determines which drivers and libraries to use
# Options: tegra186 (TX2), tegra194 (Xavier), tegra234 (Orin), tegra210 (TX1/Nano)
SOC_FAMILY = "tegra194"

# NVIDIA L4T (Linux for Tegra) version
# Must match the BSP version you're using
L4T_VERSION = "35.3.1"

# Architecture and tuning
# Default ARM architecture settings for Tegra
DEFAULTTUNE ?= "armv8a-crc-crypto"

# Alternative tunings for different platforms:
# DEFAULTTUNE ?= "aarch64"           # Generic ARMv8
# DEFAULTTUNE ?= "armv8-2a-crypto"   # ARMv8.2 with crypto

# Include ARM tune configuration
require conf/machine/include/arm/armv8a/tune-cortexa57.inc

# Kernel configuration
# ==================

# Preferred kernel provider
PREFERRED_PROVIDER_virtual/kernel = "linux-tegra"

# Kernel version
PREFERRED_VERSION_linux-tegra = "5.10%"

# Kernel image type
KERNEL_IMAGETYPE = "Image"

# Kernel device tree files
# List all DTB files needed for your custom board
KERNEL_DEVICETREE = "\
    nvidia/tegra194-custom-board.dtb \
    nvidia/tegra194-custom-board-overlay.dtbo \
"

# Additional kernel modules
MACHINE_ESSENTIAL_EXTRA_RRECOMMENDS += "\
    kernel-modules \
    kernel-module-custom-driver \
"

# Bootloader configuration
# ========================

# U-Boot configuration (if using U-Boot instead of cboot)
# PREFERRED_PROVIDER_virtual/bootloader = "u-boot-tegra"
# PREFERRED_VERSION_u-boot-tegra = "2022.04%"
# UBOOT_MACHINE = "p3310-2180_defconfig"

# CBoot configuration (NVIDIA's bootloader)
PREFERRED_PROVIDER_virtual/bootloader = "cboot-t19x"

# Partition layout configuration
PARTITION_FILE = "flash_l4t_custom.xml"
PARTITION_LAYOUT_TEMPLATE = "flash_l4t_custom_template.xml"

# Bootloader device tree
BOOTLOADER_DTB = "tegra194-custom-board.dtb"

# Graphics and multimedia
# =======================

# GPU architecture
# Options: t186 (TX2), t194 (Xavier), t234 (Orin)
CUDA_ARCHITECTURES = "72"  # For Xavier: 72, for Orin: 87

# OpenGL/EGL provider
PREFERRED_PROVIDER_virtual/egl = "nvidia-egl"
PREFERRED_PROVIDER_virtual/libgles1 = "nvidia-gles"
PREFERRED_PROVIDER_virtual/libgles2 = "nvidia-gles"
PREFERRED_PROVIDER_virtual/libgl = "mesa-tegra"

# Multimedia acceleration
PREFERRED_PROVIDER_virtual/libomx = "libomx-tegra"

# Machine features
# ================

# Standard features supported by this machine
MACHINE_FEATURES = "\
    alsa \
    bluetooth \
    ext2 \
    ext4 \
    keyboard \
    pci \
    rtc \
    screen \
    serial \
    usbgadget \
    usbhost \
    vfat \
    wifi \
"

# Optional features
MACHINE_FEATURES += "\
    cuda \
    opengl \
    vulkan \
"

# Distro features that require specific hardware
MACHINE_FEATURES_BACKFILL_CONSIDERED = "rtc"

# Hardware capabilities
# =====================

# Serial console configuration
SERIAL_CONSOLES = "115200;ttyTCU0"

# Alternative console (for debugging):
# SERIAL_CONSOLES += "115200;ttyS0"

# Audio configuration
MACHINE_AUDIO_CONF = "tegra-audio.conf"

# Camera support
MACHINE_FEATURES += "camera"

# Storage and filesystem
# ======================

# Root filesystem type
IMAGE_FSTYPES = "ext4 tar.bz2 tegraflash"

# Boot device
# Options: mmcblk0p1 (eMMC), nvme0n1p1 (NVMe SSD), sda1 (USB/SATA)
ROOTFS_DEVICE = "mmcblk0p1"

# Image size (in KB)
IMAGE_ROOTFS_SIZE ?= "8388608"  # 8GB

# Additional filesystem support
IMAGE_FSTYPES += "wic.bmap wic.gz"

# WIC (disk image creator) configuration
WKS_FILE = "tegra-custom.wks"

# Extra firmware and binary packages
# ===================================

# NVIDIA binary packages
MACHINE_EXTRA_RRECOMMENDS += "\
    tegra-firmware \
    tegra-brcm-patchram \
    tegra-nvpmodel \
    tegra-nvfancontrol \
    tegra-nvphs \
    tegra-configs-nvstartup \
"

# WiFi/Bluetooth firmware
MACHINE_EXTRA_RRECOMMENDS += "\
    linux-firmware-bcm4354 \
    linux-firmware-bcm43xx \
"

# Camera support
MACHINE_EXTRA_RRECOMMENDS += "\
    argus-camera \
    libargus-samples \
"

# Package architecture and feeds
# ==============================

# Package architectures in order of preference
PACKAGE_EXTRA_ARCHS = "\
    aarch64 \
    tegra \
    ${SOC_FAMILY} \
    ${MACHINE} \
"

# Package feed configuration
PACKAGE_ARCH = "${MACHINE_ARCH}"

# SDK and toolchain
# =================

# SDK includes these host architectures
SDKMACHINE = "x86_64"

# SDK target architecture
SDK_ARCH = "aarch64"

# Cross-compiler prefix
TARGET_SYS = "aarch64-linux"

# Toolchain configuration
TOOLCHAIN_HOST_TASK:append = " nativesdk-cmake"
TOOLCHAIN_TARGET_TASK:append = " cuda-toolkit-dev tensorrt-dev"

# Flashing configuration
# ======================

# Flash script configuration
FLASH_SCRIPT = "flash.sh"

# Flashing parameters
FLASH_BOARD_CONFIG = "jetson-custom"
FLASH_TARGET = "mmcblk0p1"

# TNSPEC (Tegraflash configuration)
TNSPEC_BOOTDEV = "mmcblk0p1"
TNSPEC_FLASH_CMD = "flash;reboot"

# Tegra binaries location
TEGRA_BINARIES_PATH = "${STAGING_DATADIR}/tegraflash"

# Power management
# ================

# NVPModel configuration file
NVPMODEL_CONFIG_DEFAULT = "nvpmodel_custom.conf"

# Fan control configuration
NVFANCONTROL_CONFIG = "nvfancontrol_custom.conf"

# Power modes (for Xavier)
# NVPMODEL_MODES = "MODE_15W MODE_30W MODE_60W"

# Networking
# ==========

# Default network interface
NETWORK_INTERFACE = "eth0"

# Additional network configuration
# PREFERRED_PROVIDER_virtual/wlan = "bcm4354"

# Miscellaneous
# =============

# Bootloader environment size
BOOTENV_SIZE = "131072"

# Extra image dependencies
EXTRA_IMAGEDEPENDS += "virtual/bootloader"

# License flags whitelist (for proprietary packages)
LICENSE_FLAGS_ACCEPTED += "commercial cuda"

# Preferred versions for critical packages
PREFERRED_VERSION_cuda-toolkit = "11.4%"
PREFERRED_VERSION_tensorrt = "8.4%"
PREFERRED_VERSION_cudnn = "8.4%"

# Usage notes:
# ============
#
# 1. Place this file in: meta-yourlayer/conf/machine/custom-jetson.conf
#
# 2. Select machine in local.conf:
#    MACHINE = "custom-jetson"
#
# 3. Build for this machine:
#    bitbake core-image-minimal
#
# 4. Check machine configuration:
#    bitbake -e | grep ^MACHINE=
#    bitbake -e | grep ^SOC_FAMILY=
#
# 5. View all machine variables:
#    bitbake -e > environment.txt
#    grep MACHINE environment.txt
#
# 6. Flash built image:
#    cd tmp/deploy/images/custom-jetson/
#    sudo ./flash.sh jetson-custom mmcblk0p1
#
# 7. Create custom partition layout:
#    Edit flash_l4t_custom.xml to define partitions
#
# 8. Customize device tree:
#    Add tegra194-custom-board.dts to kernel sources
#
# References:
# - meta-tegra layer: https://github.com/OE4T/meta-tegra
# - Yocto Machine Configuration: https://docs.yoctoproject.org/ref-manual/
# - NVIDIA L4T Documentation: https://developer.nvidia.com/l4t
